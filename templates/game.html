<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <title>Sedario | Game</title>
    <link rel="shortcut icon" type="image/ico" href="/static/img/favicon.ico"/>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/static/css/style.css">

    <!-- socketIO -->
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>


    <script src="../static/js/sedario.js"></script>
  </head>
  <body>

    {{ account_bar|safe }}

    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="panel dark">
            <div class="panel-body text-center" id="canvas-container">
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="panel dark">
            <div class="panel-heading">
              <h3 class="text-center">
                <span style="background-color: white; padding: 5px; border-radius: 5px; color: var(--dark)">{{ game.white }}</span> - vs -
                <span style="background-color: black; padding: 5px; border-radius: 5px;">{{ game.black }}</span>
              </h3>
            </div>
          </div>
        </div>
      </div>

      {% if game.state == 'f' %}

      <div class="row">
        <div class="col-md-12">
          <div class="panel dark">
            <div class="panel-heading">
              <h4 class="center-text">Recap</h4>
            </div>
            <div id="recap" class="panel-body"></div>
          </div>
        </div>
      </div>

      <script>



        function set_state() {}
      </script>

      {% end if %}

    </div>

    {{ footer|safe }}

  </body>


  {% if game.state == 'p' %}

  <script>


    function set_screen(combo_moves) {
      const s = new State(8);
      s.set_from_combo_moves(combo_moves);
      let vs = new ViewState(s, {% if game.white == user.username %}WHITE{% else %}BLACK{% endif %});
      let cont = document.getElementById('canvas-container');
      while (cont.hasChildNodes()) {
        cont.removeChild(cont.childNodes[0]);
      }
      cont.appendChild(vs.get_DOM());
      vs.update_display();
      vs.click_handler = function(sq) {
        s._find_possible_moves();
        $.ajax({
          url: '/game_access',
          data: {
            'method': 'move',
            'id':'{{ game.id }}',
            'square': sq,
            'game_over': s.possible_moves.length == 0
          },
          type: 'POST',
          cache: false,
          success: function(response) {
            update();
          },
          error: function(error){
            console.error(error.responseText);
          }
        });
      }
    }



    function update() {
      $.ajax({
        url: '/game_access',
        data: {
          'method': 'get',
          'id':'{{ game.id }}'
        },
        type: 'POST',
        cache: false,
        success: function(response) {
          set_screen(JSON.parse(response));
        },
        error: function(error){
          console.error(error);
        }
      });
    }





    var socket = io({transports: ['websocket']});

    socket.on('connect', function() {
      console.log('connected to socketIO');
    });

    // join game
    socket.emit('join game', {id:'{{ game.id }}'});

    // reload
    socket.on('reload', function(msg) {
      location.reload(true);
    });

    set_screen(JSON.parse({{ game.combo_moves|tojson }}));
    // changes to board
    socket.on('update game', function(msg) {
      update();
    });
  </script>

  {% endif %}


</html>
