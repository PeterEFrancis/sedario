<!DOCTYPE html>
<html>
  <head>
    <title>Sedario | User {{username}}</title>
    <link rel="shortcut icon" type="image/ico" href="/static/img/favicon.ico"/>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/static/css/style.css">

    <style>

      .prof-pic {
        max-width: 100%;
        background-color: white;
        border-radius: 50%;
      }

    </style>

  </head>
  <body>

    {{ account_bar|safe }}

    <div class="container">
      <div class="jumbotron dark" style="margin-top: 50px">
        <div class="row">
          <div class="col-xs-3">
            <div class="prof-pic">
              <img src="https://robohash.org/{{ user.username }}.png?size=200x200&set=set3" class="prof-pic">
            </div>
          </div>
          <div class="col-xs-9">
            <h1>{{ user.username }}</h1>
            <p class="lead">
              <span class="soft">ELO:</span> {{ user.elo }} | <span class="soft">Rank:</span> {{ user.rank or 'pending' }}
            </p>
            <button class="btn btn-default" data-toggle="modal" data-target="#accountmodal">
              <span class="glyphicon glyphicon-cog" style="color: var(--dark)"></span>
              Account Settings
            </button>
            <button type="button" class="btn btn-danger" onclick="logout()">
              Log Out
              <span class="glyphicon glyphicon-log-out"></span>
            </button>
            <script>
              function logout() {
                $.ajax({
                  url: '/logout',
                  data: {},
                  type: 'POST',
                  cache: false,
                  success: function(response) {
                    window.location.href = '/';
                  },
                  error: function(error) {
                    console.log(error.responseText);
                  },
                });
              }
              function save_account_settings() {
                let public_account = document.getElementById('public').checked;
                $.ajax({
                  url: '/user_access',
                  data: {
                    'username':{{ user.username|tojson }},
                    'method':'save_account_settings',
                    'public': public_account
                  },
                  type: 'POST',
                  cache: false,
                  success: function(response) {
                    location.reload(true);
                  },
                  error: function(error) {
                    console.log(error.responseText);
                  },
                });
              }
            </script>
          </div>
        </div>
      </div>
    </div>

    <!-- account Modal -->
    <div id="accountmodal" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Account Settings</h4>
          </div>
          <div class="modal-body">
            <div class="checkbox">
              <label><input id="public" type="checkbox" value="public" {% if user.public %} checked {% endif %}>Public Account*</label><br>
              <span class="small">(*Public accounts show up on the "recent players" list.)</span>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" onclick="save_account_settings()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row" style="margin-top: 50px; margin-bottom: 50px;">
        <div class="col-md-4"></div>
        <div class="col-md-4">
          <button class="btn btn-success btn-lg btn-block center-block" onclick="window.location.href='/play'">
            New Game
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row" style="margin-top: 30px;">
        <div class="col-md-6">
          <div class="panel dark">
            <div class="panel-heading">
              <h3 id="challenges" class="text-center">Challenges</h3>
            </div>
            <div class="panel-body">
              {% if challenges == [] %}
              <p>You have no challenges</p>
              {% else %}
              <ul class="list-group dark">
                {% for c in challenges %}
                <li class="list-group-item dark">
                  <a href="/user/{{ c[0] }}">{{ c[0] }}</a> ({% if not c[1] %}un{% endif %}rated)
                  <button style="float:right; margin-top: -0.33em;" class="btn btn-sm btn-danger" onclick='deny_challenge("{{ c[0] }}")'>Deny</button>
                  <button style="float:right; margin-top: -0.33em; margin-right: 10px;" class="btn btn-sm btn-success" onclick='accept_challenge("{{ c[0] }}");'>Accept</button>
                </li>
                {% endfor %}
              </ul>
              {% endif %}
              <script>
                function accept_challenge(c_username) {
                  $.ajax({
                    url: '/user_access',
                    data: {
                      'method': 'accept_challenge',
                      'username': {{ user.username|tojson }},
                      'c_username': c_username
                    },
                    type: 'POST',
                    cache: false,
                    success: function(response) {
                      location.href = response;
                    },
                    error: function(error) {
                      console.log(error.responseText);
                    },
                  });
                }
                function deny_challenge(c_username) {
                  $.ajax({
                    url: '/user_access',
                    data: {
                      'method': 'deny_challenge',
                      'username': {{ user.username|tojson }},
                      'c_username': c_username
                    },
                    type: 'POST',
                    cache: false,
                    success: function(response) {
                      location.reload(true)
                    },
                    error: function(error) {
                      console.log(error.responseText);
                    },
                  });
                }
              </script>
            </div>
          </div>
          <div class="panel dark">
            <div class="panel-heading">
              <h3 id="current-games" class="text-center">Current Games</h3>
              <div class="panel-body">
                {% if current_games == [] %}
                <p>You have no current games</p>
                {% else %}
                <ul class="list-group dark">
                  {% for g in current_games %}
                  <li class="list-group-item dark">
                    {{ g[0] }}</a> (#{{ g[1] }})
                    <button style="float:right; margin-top: -0.33em; margin-right: 10px;" class="btn btn-sm btn-success" onclick='location.href="/game/{{ g[1] }}"'>Open</button>
                  </li>
                  {% endfor %}
                </ul>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="panel dark">
            <div class="panel-heading">
              <h3 id="past-games" class="text-center">Past Games</h3>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="panel dark">
            <div class="panel-heading">
              <h3 id="friend-requests" class="text-center">Friend Requests</h3>
            </div>
            <div class="panel-body">
              {% if friend_requests == [] %}
              <p>You have no friend requests</p>
              {% else %}
              <ul class="list-group dark">
                {% for r_user in friend_requests %}
                <li class="list-group-item dark">
                  <a href="/user/{{ r_user }}">{{ r_user }}</a> <span class="badge">{{ r_user.elo }}</span>
                  <button style="float:right; margin-top: -0.33em;" class="btn btn-sm btn-danger" onclick='deny_friend_request({{ r_user|tojson }})'>Deny</button>
                  <button style="float:right; margin-top: -0.33em; margin-right: 10px;" class="btn btn-sm btn-success" onclick='accept_friend_request({{ r_user|tojson }})'>Accept</button>
                </li>
                {% endfor %}
              </ul>
              {% endif %}
              <script>
                function accept_friend_request(a_username) {
                  $.ajax({
                    url: '/user_access',
                    data: {
                      'method': 'accept_friend_request',
                      'username': {{ user.username|tojson }},
                      'a_username': a_username
                    },
                    type: 'POST',
                    cache: false,
                    success: function(response) {
                      location.reload(true)
                    },
                    error: function(error) {
                      console.log(error.responseText);
                    },
                  });
                }
                function deny_friend_request(d_username) {
                  $.ajax({
                    url: '/user_access',
                    data: {
                      'method': 'deny_friend_request',
                      'username': {{ user.username|tojson }},
                      'd_username': d_username
                    },
                    type: 'POST',
                    cache: false,
                    success: function(response) {
                      location.reload(true)
                    },
                    error: function(error) {
                      console.log(error.responseText);
                    },
                  });
                }
              </script>
            </div>
          </div>
          <div class="panel dark">
            <div class="panel-heading">
              <h3 id="friends" class="text-center">Friends</h3>
            </div>
            <div class="panel-body">
              {% if friends == [] %}
              <p>You have no friends :/</p>
              {% else %}
              <ul class="list-group dark">
                {% for f_user in friends %}
                <li class="list-group-item dark">
                  <a href="/user/{{ f_user.username }}">{{ f_user.username }}</a> <span class="badge">{{ f_user.elo }}</span>
                  <!-- <button style="float:right; margin-top: -0.33em;" class="btn btn-sm btn-danger" onclick='remove_friend({{ f_user.username|tojson }})'>Remove</button> -->
                </li>
                {% endfor %}
              </ul>
              {% endif %}
              <!-- <script>
                function remove_friend(f_username) {
                  $.ajax({
                    url: '/user_access',
                    data: {
                      'method': 'remove_friend',
                      'username': {{ user.username|tojson }},
                      'f_username': f_username
                    },
                    type: 'POST',
                    cache: false,
                    success: function(response) {
                      location.reload(true)
                    },
                    error: function(error) {
                      console.log(error.responseText);
                    },
                  });
                }
              </script> -->
            </div>
          </div>
          <div class="panel dark">
            <div class="panel-heading">
              <h3 class="text-center">Request Friends</h3>
            </div>
            <div class="panel-body">
              <div class="input-group">
                <input id="r_username" class="form-control dark" placeholder="username" type="text" oninput="this.value = this.value.split('').map(x=>x.toLowerCase()).map(x=>'1234567890qwertyuiopasdfghjklzxcvbnm'.includes(x) ? x : '').join('')">
                <span class="input-group-btn">
                  <button type="button" class="btn btn-success" style="border: 1px solid var(--light)" onclick='request_friend()'>Request</button>
                </span>
              </div>
              <p id="request-feedback" style="margin-top: 1em;">&nbsp;</p>
              <script>
                function request_friend(r_username) {
                  let r_user = document.getElementById('r_username').value;
                  $.ajax({
                    url: '/user_access',
                    data: {
                      'method': 'request_friend',
                      'username': {{ user.username|tojson }},
                      'r_username': r_user
                    },
                    type: 'POST',
                    cache: false,
                    success: function(response) {
                      document.getElementById('request-feedback').innerHTML = r_user + ' requested successfully!';
                      document.getElementById('r_username').value = "";
                    },
                    error: function(error) {
                      document.getElementById('request-feedback').innerHTML = error.responseText;
                      console.log(error.responseText);
                    },
                  });
                }
              </script>
            </div>
          </div>
        </div>
      </div>
    </div>

    {{ footer|safe }}

  </body>


  <script>

    function get_friend_requests() {

    }


    function get_challenges() {

    }


    function get_current_games() {

    }

  </script>

</html>
